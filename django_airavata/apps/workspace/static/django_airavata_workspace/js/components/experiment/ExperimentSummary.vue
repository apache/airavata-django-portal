<template>
  <div>
    <div class="row">
      <div class="col-auto mr-auto">
        <h1 class="h4 mb-4">
          <slot name="title">Experiment Summary</slot>
        </h1>
      </div>
      <div class="col-auto">
          <share-button :entity-id="experiment.experimentId" />
          <b-link v-if="experiment.isEditable" class="btn btn-primary" :href="editLink">
            Edit
            <i class="fa fa-edit" aria-hidden="true"></i>
          </b-link>
          <b-btn variant="primary" @click="clone">
            Clone
            <i class="fa fa-copy" aria-hidden="true"></i>
          </b-btn>
      </div>
    </div>
    <div class="row">
      <div class="col">
        <div class="card border-default">
          <div class="card-body">
            <table class="table">
              <tbody>
                <tr>
                  <th scope="row">Name</th>
                  <td>
                    <div :title="experiment.experimentId">{{ experiment.experimentName }}</div>
                    <small class="text-muted">
                    ID: {{ experiment.experimentId }}
                    (<clipboard-copy-link :text="experiment.experimentId" :link-classes="['text-reset']">
                      copy
                      <span slot="icon"></span>
                      <span slot="tooltip">Copied ID!</span>
                    </clipboard-copy-link>)
                    </small>
                  </td>
                </tr>
                <tr>
                  <th scope="row">Description</th>
                  <td>{{ experiment.description }}</td>
                </tr>
                <tr>
                  <th scope="row">Project</th>
                  <td v-if="localFullExperiment.project">{{ localFullExperiment.projectName }}</td>
                  <td v-else>
                    <em>You don't have access to this project.</em>
                  </td>
                </tr>
                <tr>
                  <th scope="row">Outputs</th>
                  <td>
                    <data-product-viewer v-for="output in localFullExperiment.outputDataProducts" :data-product="output" 
                    class="data-product" :key="output.productUri"/>
                  </td>
                </tr>
                <!-- Going to leave this out for now -->
                <!-- <tr>
                                    <th scope="row">Storage Directory</th>
                                    <td></td>
                                </tr> -->
                <tr>
                  <th scope="row">Owner</th>
                  <td>{{ experiment.userName }}</td>
                </tr>
                <tr>
                  <th scope="row">Application</th>
                  <td>{{ localFullExperiment.applicationName }}</td>
                </tr>
                <tr>
                  <th scope="row">Compute Resource</th>
                  <td>{{ localFullExperiment.computeHostName }}</td>
                </tr>
                <tr>
                  <th scope="row">Experiment Status</th>
                  <td>
                    <template v-if="localFullExperiment.experiment.isProgressing">
                      <i class="fa fa-sync-alt fa-spin"></i>
                      <span class="sr-only">Progressing...</span>
                    </template>
                    {{ localFullExperiment.experimentStatusName }}
                  </td>
                </tr>
                <tr v-if="localFullExperiment.jobDetails && localFullExperiment.jobDetails.length > 0">
                  <th scope="row">Job</th>
                  <td>
                    <table class="table">
                      <thead>
                        <th>Name</th>
                        <th>ID</th>
                        <th>Status</th>
                        <th>Creation Time</th>
                      </thead>
                      <tr v-for="(jobDetail, index) in localFullExperiment.jobDetails" :key="jobDetail.jobId">
                        <td>{{ jobDetail.jobName }}</td>
                        <td>{{ jobDetail.jobId }}</td>
                        <td>{{ jobDetail.jobStatusStateName }}</td>
                        <td>
                          <span :title="jobDetail.creationTime.toString()">{{ jobCreationTimes[index] }}</span>
                        </td>
                      </tr>
                    </table>
                  </td>
                </tr>
                <!--  TODO: leave this out for now -->
                <!-- <tr>
                                    <th scope="row">Notification List</th>
                                    <td>{{ experiment.emailAddresses
                                            ? experiment.emailAddresses.join(", ")
                                            : '' }}</td>
                                </tr> -->
                <tr>
                  <th scope="row">Creation Time</th>
                  <td>
                    <span :title="experiment.creationTime.toString()">{{ creationTime }}</span>
                  </td>
                </tr>
                <tr>
                  <th scope="row">Last Modified Time</th>
                  <td>
                    <span :title="localFullExperiment.experimentStatus.timeOfStateChange.toString()">{{ lastModifiedTime }}</span>
                  </td>
                </tr>
                <tr>
                  <th scope="row">Wall Time Limit</th>
                  <td>{{ experiment.userConfigurationData.computationalResourceScheduling.wallTimeLimit }} minutes</td>
                </tr>
                <tr>
                  <th scope="row">CPU Count</th>
                  <td>{{ experiment.userConfigurationData.computationalResourceScheduling.totalCPUCount }}</td>
                </tr>
                <tr>
                  <th scope="row">Node Count</th>
                  <td>{{ experiment.userConfigurationData.computationalResourceScheduling.nodeCount }}</td>
                </tr>
                <tr>
                  <th scope="row">Queue</th>
                  <td>{{ experiment.userConfigurationData.computationalResourceScheduling.queueName }}</td>
                </tr>
                <tr>
                  <th scope="row">Inputs</th>
                  <td>
                      <ul class="input-list"> 
                        <template v-if = "dataProductInputs.length > 0">
                          <li v-for="input in dataProductInputs">
                            {{input.name}} : 
                             <data-product-viewer 
                                :data-product="input" :input-file="true" class="data-product" :key="input.productUri"/>    
                          </li>
                        </template>

                        <template v-if = "stringInputs.length > 0">
                          <li v-for="input in stringInputs">
                              {{input.name}} : {{input.value}}
                          </li>
                        </template>
                      </ul>
                  </td>
                </tr>
                <tr>
                  <!-- TODO -->
                  <th scope="row">Errors</th>
                  <td></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import { models, services } from "django-airavata-api";
import { components } from "django-airavata-common-ui";
import DataProductViewer from "./DataProductViewer.vue";
import urls from "../../utils/urls";

import moment from "moment";

export default {
  name: "experiment-summary",
  props: {
    fullExperiment: {
      type: models.FullExperiment,
      required: true
    },
    launching: {
      type: Boolean,
      default: false
    }
  },
  data() {

    return {
      localFullExperiment: this.fullExperiment.clone()
    };

  },
  components: {
    DataProductViewer,
    "clipboard-copy-link": components.ClipboardCopyLink,
    "share-button": components.ShareButton
  },
  computed: {
    stringInputs: function() {
      return this.localFullExperiment.experiment.experimentInputs.filter(function (e) {
          return e.type.value == 0
      })
    },
    dataProductInputs: function(){
      // Filters out only data products. These objects will contain 
      // name of the file and inputOrder also
      var allFileInputs = this.localFullExperiment.experiment.experimentInputs.filter(function (e) {
            return e.type.value == 3;
      });
      
      // For each data product, find the "name" and "inputOrder" field for it
      // from the array evaluated above. Product URI is used as a key to find
      // matching data products (as it is unique to each file)
      // Returns the array sorted by inputOrder in ascending order
      var allDataProducts =  this.localFullExperiment.inputDataProducts.filter(function (dp) {
        for(var i = 0; i < allFileInputs.length; i++){
          if(allFileInputs[i]["value"] == dp["productUri"]){
            dp["name"] = allFileInputs[i]["name"]
            dp["inputOrder"] = allFileInputs[i]["inputOrder"]
          }
        }
        return dp
      })

      return sortByKey(allDataProducts, "inputOrder");
    },
    creationTime: function() {
      return moment(this.localFullExperiment.experiment.creationTime).fromNow();
    },
    lastModifiedTime: function() {
      return moment(
        this.localFullExperiment.experimentStatus.timeOfStateChange
      ).fromNow();
    },
    experiment: function() {
      return this.localFullExperiment.experiment;
    },
    jobCreationTimes: function() {
      return this.localFullExperiment.jobDetails.map(jobDetail =>
        moment(jobDetail.creationTime).fromNow()
      );
    },
    editLink() {
      return urls.editExperiment(this.experiment);
    }
  },
  methods: {
    loadExperiment: function() {

      return services.FullExperimentService.get(
        this.localFullExperiment.experiment.experimentId
      ).then(exp => (this.localFullExperiment = exp));
    },
    initPollingExperiment: function() {
      var pollExperiment = function() {
        if (
          (this.launching &&
            !this.localFullExperiment.experiment.hasLaunched) ||
          this.localFullExperiment.experiment.isProgressing
        ) {
          this.loadExperiment().then(() => {
            setTimeout(pollExperiment.bind(this), 3000);
          });
        }
      }.bind(this);
      setTimeout(pollExperiment, 3000);
    },
    clone() {
      services.ExperimentService.clone({
        lookup: this.experiment.experimentId
      }).then(clonedExperiment => {
        urls.navigateToEditExperiment(clonedExperiment);
      })
    }
  },
  watch: {},
  mounted: function() {
    this.initPollingExperiment();
  }
};
/**
*  Generic function that sorts an array 
*  of objects by key
*  Default sorting order is ascending
*  @param {Array} array
*  @param {string} key
*  @param {string} order (either asc or desc)
*/
function sortByKey(array, key, order = "asc") {
  return array.sort(function(obj1, obj2) {
    // If key doesn't exist, returns 0 
    if(!obj1.hasOwnProperty(key) || !obj2.hasOwnProperty(key)) {
      return 0;
    }
    let sortOrder = (order == 'desc') ? -1 : 1;
    var val1 = (typeof obj1[key] === 'string') ? obj1[key].toLowerCase() : obj1[key]; 
    var val2 = (typeof obj2[key] === 'string') ? obj2[key].toLowerCase() : obj2[key];
    return ((val1 < val2) ? -1 * sortOrder : ((val1 > val2) ? 1 * sortOrder : 0));
    });
  }
</script>

<style scoped>
.data-product + .data-product {
  margin-left: 0.5em;
}
.input-list {
  padding-left: .5em;
  margin-bottom: 0;
}
</style>
